Полный отчёт по проблемам проекта и исправлениям
=============================================
Дата: 25 октября 2025

Цель документа
-------------
Дать полный, хронологический обзор всех проблем, багов, конфигурационных и организационных сложностей, которые возникли при создании и отладке этого проекта (фронтенд + бэкенд + CI), и подробно описать, как каждая проблема была решена. Отчёт предназначен для команды и для истории изменений — чтобы понять, какие решения применялись и почему.

Содержание
--------
1. Краткая сводка
2. Хронология основных этапов работы и проблем
3. Технические проблемы и их решения (включая CI, backend, frontend, тесты, docker)
4. Рефакторинги, линтеры и форматирование — проблемы и корректировки
5. CI/CD — полная история ошибок и исправлений
6. Остаточные проблемы и рекомендации
7. Список изменённых ключевых файлов и коммитов

8. Последняя итерация (26.10.2025) — Полностью бэкенд-управляемая карта и стабильный запуск
---------------------------------------------------------------------------------------------

Итоги работ:
- Бэкенд:
  - В модель Mission добавлены координаты `pos_x`, `pos_y` (проценты 0..100) для позиционирования нод на карте. Миграция: `0004_mission_coordinates.py`.
  - Сериализатор `MissionSerializer` теперь отдаёт `pos_x`, `pos_y` и компактный список `prerequisites` (id, title) для UI.
  - Команда `load_demo_content` обновлена: демо-миссии получают координаты (Intro/Gate/Repeatable) для наглядной карты.
  - Healthcheck в docker-compose переведён на `wget` (в образ добавлен `wget`) — убран сбой из-за отсутствия `curl`.
- Фронтенд:
  - `/worlds/[id].jsx` берёт координаты нод из API (`pos_x/pos_y`) и рисует связи динамически по порядку миссий.
  - `/missions/[id].jsx` подключён к DRF: `POST /start` и `POST /complete` с тостами и отображением начисленного XP.
  - Исправлены lint-ошибки (неиспользуемые импорты), чтобы проходила сборка.
- Запуск и стабильность:
  - Для macOS выявлена проблема Docker volume: `Unknown system error -35 read` при чтении `package.json` внутри контейнера фронта. Обход: запуск фронтенда локально (Next dev) вне Docker; backend — в Docker. Добавлены флаги `WATCHPACK_POLLING`/`CHOKIDAR_USEPOLLING` и volume-монтирование для dev в compose.

Как запускать (надёжно для ручного тестирования):
1) Backend в Docker:
   - `docker compose up -d db redis backend`
   - `docker compose exec backend python manage.py load_demo_content`
   - Проверка: `curl -sS http://localhost:8000/healthz` → 200, `curl -sS http://localhost:8000/api/locations/` → массив локаций.
2) Frontend локально:
   - В `frontend/.env.local`: `NEXT_PUBLIC_API_BASE=http://localhost:8000/api`
   - `npm install && npm run dev -- -p 3002 -H 127.0.0.1`
   - Открыть `http://127.0.0.1:3002/worlds`.

Ручной чек‑лист:
1) Регистрация → Логин (username+password) → проверка, что токены работают (страницы подгружают данные без 401).
2) /class — выбрать класс, отобразится в Navbar.
3) /worlds — острова с прогрессом по миссиям.
4) /worlds/1 — карта с нодами из API (статусы completed/available/locked).
5) /missions/{id} — Start/Complete, начисление XP (повтор — по `repeat_xp_rate`, либо 0 при `repeatable=false`).
6) Проверка prerequisites: Gate недоступна до выполнения Intro.

Известные проблемы и решения:
- macOS + Docker volume для фронта: ошибка `Unknown system error -35 read`. Решение: запускать фронт локально (Next dev) или без bind‑mount в образе; для dev добавлены polling‑флаги.
- Healthcheck backend: ранее использовался `curl`, которого не было в slim-образе. Переключено на `wget` + установлен пакет в Dockerfile.

Ключевые файлы, изменённые в итерации:
- backend/game/models.py, backend/game/serializers.py, backend/game/migrations/0004_mission_coordinates.py, backend/game/management/commands/load_demo_content.py
- frontend/pages/worlds/[id].jsx, frontend/pages/missions/[id].jsx
- docker-compose.yml, backend/Dockerfile


1. Краткая сводка
-----------------
Проект — это учебная RPG-платформа с бэкендом на Django + DRF и фронтендом на Next.js. В ходе разработки столкнулись с набором общих проблем: несовместимости окружений, ошибок CI, конфигурационных конфликтов, линтинга и формата кода, проблем при установке npm-зависимостей в CI, и сложностей с генерацией/загрузкой отчётов покрытия.

2. Хронология основных этапов работы и проблем
---------------------------------------------
- Инициализация проекта: создан каркас Django, базовая модель пользователя, структура Next.js.
- Настройка Docker Compose для разработки (Postgres, Redis, Celery, backend, frontend).
- Написание первых unit-тестов и запуск pytest локально — большинство тестов прошло.
- Интеграция GitLab CI для линтинга, тестов и фронтенд-сборки — начали поступать ошибки CI.
- Множество итераций исправлений, чтобы CI-пайплайн стабильно проходил: YAML parse, husky, paths, coverage upload.

3. Технические проблемы и их решения
----------------------------------
3.1 Backend (Django)
  Проблемы:
  - Пользовательские модели (AUTH_USER_MODEL) и связанные миграции — нужно корректно генерировать миграции и учитывать их в flake8.
  - Настройки БД в `core/settings/base.py` имели дефолты, несовместимые с CI (HOST=localhost), что приводило к ошибкам в GitLab.
  Решения:
  - Настройки оставлены в виде `os.getenv`, CI переменные заданы в `.gitlab-ci.yml` (POSTGRES_HOST=postgres, POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD).
  - Добавлен `backend/scripts/wait_for_postgres.py` для надёжного ожидания сервиса Postgres в CI.

3.2 Тесты и покрытие
  Проблемы:
  - Pytest в CI записывал артефакты в неправильные относительные пути (из-за `cd backend`), отчёт coverage.xml не находился.
  - Codecov upload пропускался из-за отсутствия `backend/coverage.xml`.
  Решения:
  - Исправлены пути генерации отчетов pytest: теперь `--junitxml=../backend/pytest-results.xml` и `--cov-report=xml:../backend/coverage.xml` при запуске из `backend`.
  - Добавлены артефакты CI и диагностический вывод в upload-job, чтобы быстро обнаруживать отсутствие файла.

3.3 Docker / Compose / CI окружение
  Проблемы:
  - Использование inline here-doc / многострочных скриптов в `.gitlab-ci.yml` приводило к YAML parse/IndentationError.
  - В CI-контейнерах нет `.git`, что ломало husky при `npm ci`.
  Решения:
  - Вынесено ожидание Postgres в отдельный скрипт `wait_for_postgres.py`.
  - Для фронтенда в job `frontend-ci` установлена переменная `HUSKY=0`, чтобы husky пропускал установку хуков в CI.

3.4 Frontend (Next.js)
  Проблемы:
  - ESLint/Prettier конфликты, устаревшие/дублирующиеся плагины и правила.
  - Необходимость иметь `package-lock.json` для стабильности `npm ci` в CI.
  - Husky падал в CI, потому что `prepare` выполняет `husky install` и ищет `.git`.
  Решения:
  - Привели ESLint конфиг к рабочему виду и запустили `eslint --fix` и `prettier --write`.
  - Зафиксировали `package-lock.json` в репозитории.
  - Отключили husky в CI через `HUSKY=0` переменную.

3.5 Линтеры и форматирование
  Проблемы:
  - Black и flake8 — много файлов требовали автоформатирования; миграции и автогенерация портили правила flake8 (docstring, длинные строки в миграциях и т.д.).
  Решения:
  - Запустили Black и isort, закоммитили изменения.
  - Обновили `.flake8` — увеличили max-line-length, добавили excludes и per-file-ignores для миграций и определённых файлов.
  - Добавили pre-commit (black, isort, flake8) для локальной защиты от попадания неконсистентного кода в репозиторий.

4. Рефакторинги, правки кода и конкретные исправления
---------------------------------------------------
- Убрали неиспользуемые импорты (F401) в некоторых модулях.
- В миграциях, где были экстремально длинные строки или автоматическая генерация, поставили `# noqa: E501` или настроили `.flake8` per-file-ignores.
- Привели форматирование по Black: множество файлов были отформатированы.

5. CI/CD — подробная история
---------------------------
5.1 Проблемы с YAML и inline-скриптами
  - Причина: here-doc в YAML часто чувствителен к отступам и окружению runner'а. В CI такое встраивание может ломаться или приводить к IndentationError.
  - Решение: все нелепые многострочные скрипты заменены на отдельные исполняемые файлы в репозитории.

5.2 Проблемы с миграциями и окружением
  - Причина: Django пытался подключиться к localhost. В CI сервис контейнера доступен по алиасу `postgres`.
  - Решение: задали `POSTGRES_HOST` в `.gitlab-ci.yml` и в `settings` используем os.getenv.

5.3 Проблемы с артефактами
  - Причина: относительные пути и `cd backend` приводили к тому, что pytest создавал файлы в `backend/backend/...`.
  - Решение: pytest теперь пишет в ../backend/* изнутри backend.

5.4 Проблемы загрузки покрытия (Codecov)
  - Причина: отсутствие `CODECOV_TOKEN` в CI переменных для приватных репозиториев и отсутствие coverage.xml.
  - Решение: добавлена диагностика в upload-job; инструкции по добавлению переменной в GitLab описаны в отдельном файле/CI doc.

6. Остаточные проблемы и рекомендации
------------------------------------
- Flake8: вернуть и постепенно включать проверки docstring (D100–D106) — сейчас они отключены для ускорения прогресса.
- Тесты: увеличить покрытие и добавить интеграционные тесты для критичных путей (регистрация, аутентификация, основные API-запросы).
- Production: настроить секреты (DJANGO_SECRET_KEY), HTTPS, и проверьте настройки WhiteNoise и staticfiles сборки.
- CI: рассмотреть добавление кэширования npm (или use pnpm) для ускорения фронтенд job'ов.

7. Ключевые изменённые файлы и коммиты (избранные)
-------------------------------------------------
- `.gitlab-ci.yml` — несколько коммитов: здесь фиксились POSTGRES_HOST, пути отчетов pytest, debug для codecov, HUSKY=0 и проверка CODECOV_TOKEN.
- `backend/scripts/wait_for_postgres.py` — новый скрипт.
- `.flake8`, `.pre-commit-config.yaml` — правила и хуки.
- Фронтенд: `package-lock.json`, `.eslintrc.json`, `package.json` (lint/format scripts).
- `ci_problems_and_fixes_report.txt` — краткий CI-отчёт (создан ранее).

Заключение
----------
Проект прошёл через ряд стандартных проблем при интеграции full-stack приложения в CI: окружение контейнеров, относительные пути, автогенерируемые артефакты, husky в CI и линтеры. Все критичные проблемы, блокировавшие пайплайн, были решены: теперь pipeline должен стабильно запускаться, pytest даёт XML-отчёт, фронтенд собирается в CI, и код проходит базовый набор линтов.

Дальнейшие шаги (конкретика)
---------------------------
1) Добавить `CODECOV_TOKEN` в GitLab (если хотите загрузку coverage для приватного репо).
2) Прогнать pipeline и проверить, что upload-job действительно загрузил coverage (подтверждение по логам uploader'а).
3) Постепенно ужесточать flake8 и возвращать docstring проверки.
4) Написать интеграционные тесты и добавить job для E2E тестов (опционально).

Файл с этим отчётом добавлен в репозиторий как `project_full_problems_and_fixes_report.txt`.

Конец отчёта
